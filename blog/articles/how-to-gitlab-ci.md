
# Configuring gitlab-ci and fandogh

داشتن چرخه CI/CD خودکار در یک پروژه امروزه تبدیل به یک ضرورت شده و اغلب تیم‌ها با استفاده از ابزار‌های موجود در مراحل ابتدایی پروژه چرخه CI/CD را راه‌اندازی میکنند و از مزایای آن بهره میبرند.
در این بلاگ پست به طور کوتاه نحوه راه‌اندازی gitlab-ci در یک پروژه  را بررسی می‌کنیم، سناریو مورد نظر ما به این ترتیب است که :

 1. با هر بار push رو برنچ develop یک چرخه ci/cd آغاز می‌شود.
 2. در استیج اول تست‌ها اجرا شوند.
 3. در استیج دوم سورس پروژه توسط داکر بیلد می‌شود و روی رجیستری گیت‌لب push می‌شود.
 4. در استیج سوم باید ایمیج ساخته شده روی فندق دیپلوی شود.

## Gitlab registry چیست؟
گیت‌لب امکانات زیادی در اختیار توسعه‌دهنده‌ها قرار می‌دهد که یکی از آنها یک [registry خصوصی داکر](https://docs.docker.com/registry/introduction/) ایمیج‌ها است.
شما می‌توانید به اندازه محدودیت‌ اکانت رایگان، ایمیج بسازید و روی آن ایمیج تگ‌های مختلف ایجاد کنید، مثلا در این مثال ما یک ایمیج با تگ staging می‌سازیم تا بتوانیم آن ایمیج را به طور خودکار توسط فندق دریافت کنیم و اجرا کنیم.

## Gitlab-ci چیست؟
یکی دیگر از امکانات رایگان گیت‌لب، ابزاری است به نام gitlab-ci که به کمک آن می‌توانید سناریو‌های مختلف برای ci/cd ایجاد کنید.

> ci/cd مخفف continues integration/continues delivery می‌باشد، به این معنی که به طور مستمر و خودکار  کامپوننت‌های نرم‌افزاری تولید شده، تست شوند، دیپلوی شوند و بعد از دیپلوی با هم Integrate شوند.
> داشتن یک چرخه ci/cd ضمن اینکه بسیاری از امور تکراری را حذف می‌کند که موجب افزایش سرعت توسعه و تحویل می‌شود ، کیفیت تولید نرم‌افزار را با اجرا مداوم تست‌ها بالا میبرد.
> طراحی یک چرخه ci/cd کارا می‌تواند زمینه را برای اجرای بسیاری از سیاست‌های کیفی کد تولید شده فراهم کند، که بدون وجود آن باید به طور دستی انجام شود.

سرویس gitlab-ci به طور کامل از طریق یک فایل کانفیگ به نام `.gitlab-ci.yml` و تنظیمات پنل گیتلب قابل کنترل و برنامه‌ریزی است که در مراحل آینده دقیق‌تر مورد بررسی قرار میگیرند.

## قدم اول: ساخت SECRERT برای گرفتن image
برای اینکه فندق بتواند ایمیج‌های شما را جهت اجرا از روی رجیستری خصوصی شما از گیت‌لب دریافت کند لازم است که یک SECRET در فندق ایجاد کنید که بعدا برای manifest هایی که می‌نویسیم مورد استفاده قرار میگیرند.
برای این منظور [ابتدا باید یک deploy token در پنل گیت‌لب بسازیم](https://docs.gitlab.com/ee/user/project/deploy_tokens/)، که در نهایت  یک username و یک deploy-token در اختیار شما قرار می‌دهد.
اگر داکر روی سیستم نصب دارید می‌توانید همین الان تست کنید ببینید که اطلاعات داده شده درست کار می‌کنند یا نه مطابق [این قسمت](https://docs.gitlab.com/ee/user/project/deploy_tokens/#read-container-registry-images) در مستندات گیت‌لب پیش برید.
با داشتن username و deploy-token ای که گیت‌لب طی فرایند ساخت deploy-token  در اختیار شما قرار داد می‌توانیم [یک سیکرت در فندق بسازیم](https://docs.fandogh.cloud/docs/secret.html):

```
fandogh  secret create  \
          --name gitlab-cred \
          -t docker-registry \
          -f server=registry.gitlab.com \
          -f username=USERNAME \
          -f password=DEPLOY_TOKEN

```

> **نکته**: توجه داشته باشید به جای USERNAME نباید username گیت‌لب خودتان را
> قرار دهید، بلکه یوزرنیمی که گیت‌لب حین ساخت deploy-token در اختیارتان
> گذاشت را باید استفاده کنید.
> 
> **نکته**: نامی که برای سیکرت انتخاب کردید را به یاد داشته باشید بعدا به آن
> نیاز داریم.

حالا اگر لیست SECRET ها را چک کنید `fandogh secret list‍` باید نام سیکرت تازه ساخته شده را به شما نمایش دهد.
## قدم دوم: نوشتن manifestهای مورد نیاز
برای پیروی از اصول [IaC](https://en.wikipedia.org/wiki/Infrastructure_as_code) فندق طوری طراحی شده که شما می‌توانید نحوه دیپلوی یک سرویس را توسط یک فایل توصیف کنید، برای اطلاعات بیشتر [مستندات مانیفست سرویس](https://docs.fandogh.cloud/docs/service-manifest.html) را مطالعه کنید.
برای شروع نیاز داریم که مانیفست‌های مورد نیاز را بنویسیم و در داخل ریپو پروژه قرار دهیم، ممکن است لازم باشد برای محیط‌های مختلف مثل production یا staging مانیفست‌های مختلف بنویسید.

> یکی از قابلیت‌های مهم مانیفست [قابلیت داشتن متغیر](https://docs.fandogh.cloud/docs/service-manifest.html#%D9%82%D8%A7%D8%A8%D9%84%DB%8C%D8%AA-%D8%A7%D8%B3%D8%AA%D9%81%D8%A7%D8%AF%D9%87-%D8%A7%D8%B2-%D9%85%D8%AA%D8%BA%DB%8C%D8%B1-%D8%AF%D8%B1-manifest) است، یعنی می‌توان هر
> قسمتی از مانیفست را به جای اینکه مستقیما مقدار داد از یک متغیر استفاده
> کرد و مقدار دهی به متغیر را هنگام دیپلوی انجام داد.

به عنوان مثال مانیفست زیر یک نمونه ExternalService است:

```
kind: ExternalService
name: hello-world
spec:
  image: %{IMAGE_URL}:${TAG}
  image_pull_policy: Always
  image_pull_secret: "${SEC_NAME}"
  env:
    - name: DEBUG
      value: 1
    - name: API_KEY
      value: ${API_KEY}

  domains:
     - name: hello-world.my-company.com
     - name: hw.my-company.com

```
نکات مهم در مورد این مانیفست:

 - چون این فایل قرار است داخل ریپوی پروژه قرار بگیرد، یکسری از اطلاعات را [تبدیل به متغیر کردیم](https://docs.fandogh.cloud/docs/service-manifest.html#%D9%82%D8%A7%D8%A8%D9%84%DB%8C%D8%AA-%D8%A7%D8%B3%D8%AA%D9%81%D8%A7%D8%AF%D9%87-%D8%A7%D8%B2-%D9%85%D8%AA%D8%BA%DB%8C%D8%B1-%D8%AF%D8%B1-manifest) که عبارتند از:

	 - IMAGE_URL: ادرس محل قرار گرفتن ایمیج را متغیر در نظر گرفتیم که اگر بعدا داکر رجیستریی که پروژه در آن پوش می‌شود تغییر کرد، نیاز به تغییر مانیفست نباشد.
	 - TAG: تگی که باید از رجیستری pull شود نیز در این مانیفست یک متغیر است که باید هنگام دیپلوی مشخص شود.
	 - SEC_NAME: برای اینکه فندق بتواند ایمیج را از رجیستری خصوصی شما بخواند نیاز به اطلاعات لاگین دارد، به همین منظور ما در قدم قبلی یک سیکرت ساختیم که حاوی این اطلاعات بود، چون ممکن است شما رجیستری خود را جا به جا کنید یا چند رجیستری داشته باشید، نام این سیکرت را به صورت متغیر در آوردیم که هنگام دیپلوی بتوان با نام‌های مختلف بسته به داکر رجیستری انتخابی دیپلوی انجام داد.
	 - یکی از پارامتر‌های env هم به نام API_KEY هم به عنوان مثال به متغیر تبدیل شده که در این مثال نشان دهیم می‌توانیم در محیط‌های مختلف پروژه را با env variable های متفاوت دیپلوی کنید.

در پایان این مرحله شما باید مانیفست‌های مورد نیاز خود را بنویسید و در ریپوی پروژه قرار دهید.
به عنوان مثال ما این فایل‌ها را در مسیر `deployment/fandogh-manifests` قرار می‌دهیم.

## قدم سوم: نوشتن اسکریپت‌های لازم
قبل از اینکه بتوانیم به سراغ فایل کانفیگ `gitlab-ci.yml` برویم یک سری اسکریپت نیاز داریم که امور مورد نیاز ما مثل بیلد کردن پروژه، تست کردن پروژه و از همینطور پابلیش کردن روی فندق را انجام دهند.
ما برای این منظور، در این مثال، دو فایل زیر را ایجاد می‌کنیم و داخل ریپوی پروژه قرار می‌دهیم:
 1. برای اجرای تست‌های پروژه: `deployment/scripts/run-tests.sh`
 2. برای دیپلوی کردن پروژه: `deployment/scripts/deploy-to-fandogh.sh`

> این اسکریپت‌ها حین اجرا ممکن است نیاز به یک‌سری اطلاعات نیاز داشته باشند، نگران نباشید این موضوع را جلوتر توضیح میدهیم.



