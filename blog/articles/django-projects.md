# چطور پروژه جنگو را توی فندق دیپلوی کنیم؟
برای دیپلوی کردن پروژه جنگو یا هر پروژه دیگه‌ای روی فندق لازمه که پروژه داکرایز بشه، یعنی این قابلیت رو داشته باشه که روی یک Container docker به درستی اجرا بشه.    
شاید یکم پیچیده به نظر برسه اما اگر این آموزش رو قدم به قدم پیش برید به سادگی می‌تونید اینکار رو انجام بدید.

وقتی پروژه جنگو رو میخواید در قالب یک Container اجرا کنید باید اولا چند تا تغییر کوچک روی پروژه بدید و دوما یک  Dockerfile برای پروژه بنویسید،‌ که هر کدوم رو توضیح میدم:

## تغییرات پروژه

### دیتابیس
پروژه‌های جنگو تقریبا همیشه یک دیتابیسی دارند، مهم نیست دیتابیس شما sqlite باشه یا MySQL یا Postgresql یا هر چیز دیگه‌ای می‌تونید از فندق استفاده کنید اما در مورد هر دیتابیسی یه سری نکات هست باید حواستون باشه:

#### نکات مربوط به دیتابیس Sqlite 

دیتابیس sqlite برای ذخیره سازی اطلاعات از یک فایل استفاده می‌کنه و اگر جنگو کار کرده باشید می‌دونید که معمولا اون فایل رو همونجا کنار فایل `manage.py‍‍‍` می‌سازه و این دقیقا یکی از مسائلی هستش که باید توی داکرایز کردن مورد توجه قرار بدید.      
فضایی که داخل container ها وجود داره مانا نیست، یعنی هر زمانی ممکنه container ریست بشه و اون فضا به طور کل خالی میشه و از نو  ساخته میشه پس اگر دیتابیس رو اونجا قرار بدید اطلاعاتتون رو ممکنه از دست بدید.
یکی از امکاناتی که فندق در اختیار کاربرانش قرار میده یک فضا مانا هستش، فضایی که متعلق به کاربر هستش و می‌تونه با اطمینان داخلش بنویسه.    
این فضا توی آدرس `/mnt/shared-storage` قابل دسترس هستش، کافیه که به جنگو بگید فایل دیتابیس رو اونجا بسازه.    
برای اینکار کافیه توی `settings.py` به این شکل `DATABASE` رو تنظیم کنید:

```
PERSISTENT_STORAGE = "/mnt/shared-storage"
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': os.path.join(PERSISTENT_STORAGE, 'db.sqlite3'),
    }
}
```
اول یک متغیر تعریف کردیم که حاوی آدرس `/mnt/shared-storage` هستش و بعد هم با به کمک `os.path.join‍‍` مشخص کردیم که محلی که جنگو برای ذخیره دیتابیس باید استفاده کنه باید `/mnt/shared-storage/db.sqlite3` باشه.


#### نکات مربوط به دیتابیس MySQL

برای دیتابیس MySQL به طور خاص می‌تونید از قابلیت managed-service استفاده کنید، این قابلیت یک دیتابیس MySQL برای شما ایجاد می‌کنه و با نام‌کاربری و رمزعبوری که انتخاب می‌کنید روی آدرس دلخواه شما در اختیار شما قرار میده.
برای ساخت یک دیتابیس MySQL باید از fandogh_cli استفاده کنید و می‌تونید روش انجام اینکار رو
**[اینجا](https://github.com/fandoghpaas/fandogh-cli#managed-services)**
مطالعه کنید.          
مثلا با چنین دستوری یک سرویس MySQL برای شما ساخته میشه:
```

 fandogh managed-service deploy mysql 9.4 -c service_name=my-database -c phpmyadmin_enabled=true -c mysql_root_password=test123
```

توجه داشته باشید که اسم سرویسی که انتخاب کردید مهم هستش، اگر اسمی انتخاب نکنید به صورت پیشفرض نام سرویس mysql خواهد بود، مثلا من اینجا my-database رو به عنوان اسم سرویس انتخاب کردم اگر انتخاب نمی‌کردم همون mysql اسم سرویسم میشد.        
دقت کنید که باید اول از طریق PHPMyAdminای که برای شما ساخته میشه یک دیتابیس بسازید، کافیه روی لینکی که که از fandogh_cli گرفتید کلیک کنید با یوزرنیم root و پسوردی که انتخاب کردید وارد PHPMyAdmin بشید.           
حالا داخل PHPMyAdmin می‌تونید به سادگی دیتابیس رو بسازید، اگر یک نگاهی به منو ها بندازید کار سختی نیست راحت می‌تونید بسازید ولی اگر مشکلی خوردید 
**[این آموزش](http://webvaultwiki.com.au/Default.aspx?Page=Create-Mysql-Database-User-Phpmyadmin&NS=&AspxAutoDetectCookieSupport=1)**
 رو دنبال کنید.
حالا با داشتن username و password و database name میتونید به سادگی تنظیمات جنگو رو مشخص کنید تا از MySQL استفاده کنه:

```
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql', 
        'NAME': 'my-project',
        'USER': 'root',
        'PASSWORD': 'test123',
        'HOST': 'my-database',   
        'PORT': '3306',
    }
}

```
دقت کنید که به جای HOST باید مقداری که به عنوان service_name موقع ساخت سرویس استفاده کردید رو بنویسید.


#### نکات مربوط به دیتابیس‌های دیگر
برای بقیه دیتابیس‌ها هم کار سختی نیست، کافیه که توی 
** [docker hub ](https://hub.docker.com/explore/) **
سرچ کنید داکرفایلشون رو پیدا کنید و 
**[سرویستون رو از روی داکرفایل اون‌ها بسازید.](http://blog.fandogh.cloud/articles/fandogh-introduction.html)**
البته اگر کمکی نیاز داشتید می‌دونید که ما همیشه هستیم و آماده پاسخگویی به شما دوستان عزیز


### تغییرات مربوط به فایل‌های استاتیک
 
توی پروژه‌های جنگو وقتی مایل باشید پروژه رو توی مد پروداکشن دیپلوی کنید نمی‌تونید از runserver استفاده کنید و باید فایل‌های استاتیک و media رو جداگانه با یک webserver سرو کنید.
برای اینکار فعلا به جنگو باید بگیم که فایل‌های مدیا و استاتیک رو داخل `/mnt/shared-storage` قرار بده تا بعدا با یک وبسرور اون آدرس رو سرو کنیم.

برای اینکار داخل `settings.py` باید STATIC_ROOT و ‌MEDIA_ROOT رو ست کنیم:

```
PERSISTENT_STORAGE = "/mnt/shared-storage"
STATIC_ROOT = os.path.join(PERSISTENT_STORAGE, 'static')
MEDIA_ROOT = os.path.join(PERSISTENT_STORAGE, 'media')


```
حالا کل فایل‌های استاتیک و مدیا رفت توی storageای که مانا هستش و جاش امنه

### استفاده از Environment variables

نکاتی که تا الان گفتیم رو به همون شکلی که توضیح دادیم می‌تونید استفاده کنید، اما بهتر این هستش که یک سری مقادیر که تغییر می‌کنه اینطوری داخل کد نوشته نشه، مثلا HOSTای که برای MySQL استفاده می‌کنید یا USERNAME و PASSWORD بهتر هستش که از environment variables خونده بشه، ما هم توی این آموزش همین کار رو می‌کنیم، مثلا برای MySQL  این تنظیمات رو استفاده می‌کنیم:

```

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': os.environ.get("MYSQL_DB_NAME"),
        'USER': os.environ.get("MYSQL_USERNAME"),
        'PASSWORD': os.environ.get("MYSQL_PASSWORD"),
        'HOST': os.environ.get("MYSQL_HOST_NAME"),
        'PORT': '3306',
    }
}
```
به این ترتیب ما توی کد هیچ کدام از مقادیر متغیر رو قرار ندادیم و لازمه که موقع دیپلوی سرویس این مقادیر رو در اختیار app  قرار بدیم.
در مورد مقدار متغیر ‍‍`PERSISTENT_STORAGE`  هم می‌تونیم همین کار رو بکنیم:

```
PERSISTENT_STORAGE = os.environ.get("PERSISTENT_STORAGE")

```
